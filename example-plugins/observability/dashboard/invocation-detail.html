<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invocation Details - Event Detector Observability</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .back-button {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
            text-decoration: none;
            display: inline-block;
        }

        .back-button:hover {
            background: #5a67d8;
        }

        .invocation-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-card label {
            font-weight: bold;
            color: #555;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .info-card .value {
            color: #333;
            font-size: 1.1rem;
        }

        .flow-container {
            background: white;
            border-radius: 10px;
            height: 600px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .flow-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .flow-diagram {
            width: 100%;
            height: calc(100% - 55px);
            overflow: auto;
            padding: 20px;
        }

        .flow-svg {
            min-width: 100%;
            height: 100%;
        }

        .flow-node {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .flow-node:hover {
            transform: scale(1.05);
        }

        .flow-node-text {
            font-size: 12px;
            fill: white;
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .loading, .error {
            padding: 40px;
            text-align: center;
            font-size: 1.2rem;
        }

        .loading {
            color: #667eea;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            margin: 20px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .details-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .details-section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .event-item, .job-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }

        .event-item.failed, .job-item.failed {
            border-left-color: #dc3545;
        }

        .event-item.not-detected {
            border-left-color: #6c757d;
        }

        .item-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .item-details {
            font-size: 0.9rem;
            color: #666;
        }

        /* ReactFlow custom node styles */
        .react-flow__node-invocation {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 150px;
            text-align: center;
        }

        .react-flow__node-event {
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            min-width: 120px;
            text-align: center;
        }

        .react-flow__node-event.not-detected {
            background: #6c757d;
        }

        .react-flow__node-event.failed {
            background: #dc3545;
        }

        .react-flow__node-job {
            background: #17a2b8;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            min-width: 100px;
            text-align: center;
            font-size: 0.9rem;
        }

        .react-flow__node-job.failed {
            background: #dc3545;
        }

        .node-title {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .node-details {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="simple-dashboard-cors-fix.html" class="back-button">‚Üê Back to Dashboard</a>
            <h1 id="pageTitle">Invocation Details</h1>

            <div class="invocation-info" id="invocationInfo">
                <!-- Invocation details will be populated here -->
            </div>
        </div>

        <div class="flow-container">
            <div class="flow-header">Execution Flow Diagram</div>
            <div class="flow-diagram" id="flowDiagram">
                <div id="loading" class="loading">Loading invocation details...</div>
                <div id="error" class="error" style="display: none;"></div>
            </div>
        </div>

        <div class="details-grid">
            <div class="details-section">
                <h3>Event Detections</h3>
                <div id="eventsList">
                    <!-- Event details will be populated here -->
                </div>
            </div>

            <div class="details-section">
                <h3>Job Executions</h3>
                <div id="jobsList">
                    <!-- Job details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get invocation ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const invocationId = urlParams.get('id');

        // Configuration
        let HASURA_ENDPOINT = localStorage.getItem('hasuraEndpoint') || 'http://localhost:8080/v1/graphql';
        let ADMIN_SECRET = localStorage.getItem('adminSecret') || 'local-docker-hasura-secret';

        async function makeRequest(url, body) {
            const headers = {
                'Content-Type': 'application/json',
            };

            if (ADMIN_SECRET && ADMIN_SECRET.trim() !== '') {
                headers['x-hasura-admin-secret'] = ADMIN_SECRET;
            }

            return fetch(url, {
                method: 'POST',
                headers,
                body: JSON.stringify(body)
            });
        }

        const getInvocationDetailQuery = (id) => `
            query GetInvocationDetail($id: uuid!) {
                invocations_by_pk(id: $id) {
                    id
                    correlation_id
                    source_function
                    source_system
                    status
                    created_at
                    total_duration_ms
                    events_detected_count
                    total_jobs_run
                    total_jobs_succeeded
                    total_jobs_failed
                    error_message
                    source_event_payload
                }

                event_executions(where: {invocation_id: {_eq: $id}}, order_by: {created_at: asc}) {
                    id
                    event_name
                    event_module_path
                    detected
                    detection_duration_ms
                    handler_duration_ms
                    created_at
                    detection_error
                    detection_error_stack
                    handler_error
                    handler_error_stack
                    status
                    jobs_count
                    jobs_succeeded
                    jobs_failed
                }

                job_executions(where: {invocation_id: {_eq: $id}}, order_by: {created_at: asc}) {
                    id
                    event_execution_id
                    job_name
                    job_function_name
                    status
                    duration_ms
                    created_at
                    updated_at
                    job_options
                    result
                    error_message
                    error_stack
                }
            }
        `;

        async function loadInvocationDetails() {
            try {
                const response = await makeRequest(HASURA_ENDPOINT, {
                    query: getInvocationDetailQuery(invocationId),
                    variables: { id: invocationId }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.errors) {
                    throw new Error(result.errors.map(e => e.message).join(', '));
                }

                const { invocations_by_pk: invocation, event_executions, job_executions } = result.data;

                if (!invocation) {
                    throw new Error('Invocation not found');
                }

                populateInvocationInfo(invocation);
                populateEventsList(event_executions);
                populateJobsList(job_executions);
                createFlowDiagram(invocation, event_executions, job_executions);

                document.getElementById('loading').style.display = 'none';

            } catch (err) {
                console.error('Error loading invocation details:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <strong>Error loading invocation details:</strong> ${err.message}
                    <br><br>
                    <strong>Endpoint:</strong> ${HASURA_ENDPOINT}
                    <br>
                    <strong>Invocation ID:</strong> ${invocationId}
                    <br><br>
                    <p>Make sure the observability tables are tracked in Hasura and the invocation exists.</p>
                `;
            }
        }

        function populateInvocationInfo(invocation) {
            document.getElementById('pageTitle').textContent = `Invocation: ${invocation.source_function}`;

            const duration = invocation.total_duration_ms ? `${invocation.total_duration_ms}ms` : 'Unknown';
            const startTime = new Date(invocation.created_at).toLocaleString();
            const endTime = invocation.status === 'completed' ? 'Completed' : 'In progress';

            document.getElementById('invocationInfo').innerHTML = `
                <div class="info-card">
                    <label>Function</label>
                    <div class="value">${invocation.source_function}</div>
                </div>
                <div class="info-card">
                    <label>Source System</label>
                    <div class="value">${invocation.source_system || 'Unknown'}</div>
                </div>
                <div class="info-card">
                    <label>Status</label>
                    <div class="value">${invocation.status}</div>
                </div>
                <div class="info-card">
                    <label>Duration</label>
                    <div class="value">${duration}</div>
                </div>
                <div class="info-card">
                    <label>Events Detected</label>
                    <div class="value">${invocation.events_detected_count || 0}</div>
                </div>
                <div class="info-card">
                    <label>Jobs Run</label>
                    <div class="value">${invocation.total_jobs_run || 0} (${invocation.total_jobs_succeeded || 0} succeeded, ${invocation.total_jobs_failed || 0} failed)</div>
                </div>
                <div class="info-card">
                    <label>Started</label>
                    <div class="value">${startTime}</div>
                </div>
                <div class="info-card">
                    <label>Status</label>
                    <div class="value">${endTime}</div>
                </div>
                <div class="info-card">
                    <label>Correlation ID</label>
                    <div class="value" style="font-size: 0.9rem;">${invocation.correlation_id}</div>
                </div>
            `;
        }

        function populateEventsList(events) {
            if (!events || events.length === 0) {
                document.getElementById('eventsList').innerHTML = '<p style="color: #666;">No events detected for this invocation.</p>';
                return;
            }

            const eventsHtml = events.map(event => {
                const className = event.detected ? (event.detection_error || event.handler_error ? 'failed' : '') : 'not-detected';
                const status = event.detected ? (event.detection_error || event.handler_error ? 'Failed' : 'Detected') : 'Not Detected';
                const duration = event.detection_duration_ms ? `${event.detection_duration_ms}ms` : 'Unknown';
                const handlerDuration = event.handler_duration_ms ? `${event.handler_duration_ms}ms` : 'N/A';
                const errorMessage = event.detection_error || event.handler_error;

                return `
                    <div class="event-item ${className}">
                        <div class="item-header">${event.event_name || event.event_module_path}</div>
                        <div class="item-details">
                            <strong>Status:</strong> ${status}<br>
                            <strong>Detection Time:</strong> ${duration}<br>
                            <strong>Handler Time:</strong> ${handlerDuration}<br>
                            <strong>Jobs Run:</strong> ${event.jobs_count || 0} (${event.jobs_succeeded || 0} succeeded, ${event.jobs_failed || 0} failed)
                            ${errorMessage ? `<br><strong>Error:</strong> ${errorMessage}` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('eventsList').innerHTML = eventsHtml;
        }

        function populateJobsList(jobs) {
            if (!jobs || jobs.length === 0) {
                document.getElementById('jobsList').innerHTML = '<p style="color: #666;">No jobs executed for this invocation.</p>';
                return;
            }

            const jobsHtml = jobs.map(job => {
                const className = job.status === 'failed' ? 'failed' : '';
                const duration = job.duration_ms ? `${job.duration_ms}ms` : 'Unknown';
                const startTime = new Date(job.created_at).toLocaleString();

                return `
                    <div class="job-item ${className}">
                        <div class="item-header">${job.job_name}</div>
                        <div class="item-details">
                            <strong>Status:</strong> ${job.status}<br>
                            <strong>Duration:</strong> ${duration}<br>
                            <strong>Started:</strong> ${startTime}
                            ${job.error_message ? `<br><strong>Error:</strong> ${job.error_message}` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('jobsList').innerHTML = jobsHtml;
        }

        function createFlowDiagram(invocation, events, jobs) {
            // Clear the container
            const container = document.getElementById('flowDiagram');
            container.innerHTML = '';

            // Calculate dimensions
            const nodeWidth = 160;
            const nodeHeight = 80;
            const horizontalSpacing = 250;
            const verticalSpacing = 100;

            // Calculate SVG dimensions
            const numColumns = 4; // Start -> Events -> Jobs -> End
            const maxRows = Math.max(1, events.length, jobs.length);
            const svgWidth = numColumns * horizontalSpacing + 100;
            const svgHeight = maxRows * verticalSpacing + 200;

            // Create SVG
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', svgWidth);
            svg.setAttribute('height', svgHeight);
            svg.setAttribute('class', 'flow-svg');

            let currentX = 50;
            const centerY = svgHeight / 2;

            // Helper function to create a node
            function createNode(x, y, width, height, title, subtitle, color) {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'flow-node');

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', width);
                rect.setAttribute('height', height);
                rect.setAttribute('rx', 8);
                rect.setAttribute('fill', color);
                rect.setAttribute('stroke', color);
                rect.setAttribute('stroke-width', 2);

                const text1 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text1.setAttribute('x', x + width / 2);
                text1.setAttribute('y', y + height / 2 - 10);
                text1.setAttribute('class', 'flow-node-text');
                text1.setAttribute('font-weight', 'bold');
                text1.textContent = title;

                const text2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text2.setAttribute('x', x + width / 2);
                text2.setAttribute('y', y + height / 2 + 10);
                text2.setAttribute('class', 'flow-node-text');
                text2.setAttribute('font-size', '10');
                text2.textContent = subtitle;

                g.appendChild(rect);
                g.appendChild(text1);
                g.appendChild(text2);

                return g;
            }

            // Helper function to create an arrow
            function createArrow(x1, y1, x2, y2) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke', '#999');
                line.setAttribute('stroke-width', 2);
                line.setAttribute('marker-end', 'url(#arrowhead)');
                return line;
            }

            // Add arrow marker definition
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '7');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3.5');
            marker.setAttribute('orient', 'auto');

            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
            polygon.setAttribute('fill', '#999');

            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);

            // Add invocation start node
            const startNode = createNode(
                currentX,
                centerY - nodeHeight / 2,
                nodeWidth,
                nodeHeight,
                'Invocation Start',
                invocation.source_function,
                '#667eea'
            );
            svg.appendChild(startNode);

            currentX += horizontalSpacing;

            // Add event nodes
            const eventNodes = [];
            const eventStartY = centerY - (events.length * verticalSpacing) / 2;

            events.forEach((event, index) => {
                const y = eventStartY + index * verticalSpacing;
                const color = event.detected ?
                    ((event.detection_error || event.handler_error) ? '#dc3545' : '#28a745') :
                    '#6c757d';

                const node = createNode(
                    currentX,
                    y,
                    nodeWidth,
                    nodeHeight,
                    event.event_name || event.event_module_path || 'Event',
                    `${event.detected ? 'Detected' : 'Not Detected'} (${event.detection_duration_ms || 0}ms)`,
                    color
                );
                svg.appendChild(node);
                eventNodes.push({ x: currentX + nodeWidth, y: y + nodeHeight / 2, id: event.id });

                // Connect from start to event
                svg.appendChild(createArrow(
                    50 + nodeWidth,
                    centerY,
                    currentX,
                    y + nodeHeight / 2
                ));
            });

            currentX += horizontalSpacing;

            // Add job nodes
            if (jobs.length > 0) {
                const jobStartY = centerY - (jobs.length * verticalSpacing) / 2;

                jobs.forEach((job, index) => {
                    const y = jobStartY + index * verticalSpacing;
                    const color = job.status === 'failed' ? '#dc3545' : '#17a2b8';

                    const node = createNode(
                        currentX,
                        y,
                        nodeWidth,
                        nodeHeight,
                        job.job_name || 'Job',
                        `${job.status} (${job.duration_ms || 0}ms)`,
                        color
                    );
                    svg.appendChild(node);

                    // Connect from related event to job
                    const eventNode = eventNodes.find(e => e.id === job.event_execution_id);
                    if (eventNode) {
                        svg.appendChild(createArrow(
                            eventNode.x,
                            eventNode.y,
                            currentX,
                            y + nodeHeight / 2
                        ));
                    }
                });

                currentX += horizontalSpacing;
            }

            // Add invocation end node
            const endColor = invocation.status === 'completed' ? '#28a745' : '#dc3545';
            const endNode = createNode(
                currentX,
                centerY - nodeHeight / 2,
                nodeWidth,
                nodeHeight,
                'Invocation End',
                `${invocation.status} (${invocation.total_duration_ms || 0}ms)`,
                endColor
            );
            svg.appendChild(endNode);

            // Connect to end node
            if (jobs.length > 0) {
                const jobStartY = centerY - (jobs.length * verticalSpacing) / 2;
                jobs.forEach((job, index) => {
                    const y = jobStartY + index * verticalSpacing;
                    svg.appendChild(createArrow(
                        currentX - horizontalSpacing + nodeWidth,
                        y + nodeHeight / 2,
                        currentX,
                        centerY
                    ));
                });
            } else {
                eventNodes.forEach(eventNode => {
                    svg.appendChild(createArrow(
                        eventNode.x,
                        eventNode.y,
                        currentX,
                        centerY
                    ));
                });
            }

            container.appendChild(svg);
        }

        // Initialize the page after all functions are defined
        window.addEventListener('DOMContentLoaded', () => {
            if (!invocationId) {
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'No invocation ID provided. Please return to the dashboard.';
                document.getElementById('loading').style.display = 'none';
            } else {
                loadInvocationDetails();
            }
        });
    </script>
</body>
</html>